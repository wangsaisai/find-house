<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šç”¨æ™ºèƒ½å‡ºè¡ŒæœåŠ¡</title>
    <!-- å¼•å…¥marked.jsç”¨äºMarkdownæ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥highlight.jsç”¨äºä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            margin-bottom: 30px;
        }

        .examples-section {
            margin-bottom: 20px;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .examples-grid.expanded {
            max-height: 1000px;
        }

        .examples-toggle {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-decoration: underline;
        }

        .examples-toggle:hover {
            color: #764ba2;
        }

        .main-workspace {
            min-height: 600px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .workspace-content {
            display: none;
        }

        .workspace-content.active {
            display: block;
        }

        .analysis-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .result-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .result-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 968px) {
            .analysis-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .examples-grid {
                grid-template-columns: 1fr;
            }
        }

        /* å¯¹è¯æ¨¡å¼å æ»¡æ•´ä¸ªç©ºé—´ */
        .chat-mode .chat-container {
            height: 600px;
        }

        .chat-mode .chat-messages {
            min-height: 450px;
            max-height: 500px;
        }

        /* å¢åŠ å®¹å™¨æœ€å¤§å®½åº¦ */
        .container {
            max-width: 1400px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .response-area {
            grid-column: 1 / -1;
        }

        .response-content {
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
            min-height: 200px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Markdownæ ·å¼ä¼˜åŒ– */
        .response-content h1 {
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .response-content h2 {
            color: #34495e;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .response-content h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .response-content h4 {
            color: #7b68ee;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .response-content h5, .response-content h6 {
            color: #6c757d;
            margin-top: 12px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .response-content p {
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .response-content ul, .response-content ol {
            margin-bottom: 15px;
            padding-left: 25px;
        }

        .response-content li {
            margin-bottom: 6px;
            color: #2c3e50;
        }

        .response-content strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .response-content em {
            color: #667eea;
            font-style: italic;
        }

        .response-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .response-content th {
            background-color: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .response-content td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            color: #2c3e50;
        }

        .response-content tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .response-content tr:hover {
            background-color: #e9ecef;
        }

        .response-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 16px;
            margin: 15px 0;
            color: #6c757d;
            font-style: italic;
            background-color: #f8f9fa;
            padding: 12px 16px;
            border-radius: 4px;
        }

        .response-content code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        .response-content pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .response-content pre code {
            background: none;
            padding: 0;
            color: #2c3e50;
        }

        .response-content hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #667eea, #764ba2);
            margin: 25px 0;
            border-radius: 1px;
        }

        /* ç‰¹æ®Šæ ·å¼ */
        .response-content .emoji {
            font-size: 1.2em;
        }

        .response-content .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* ç­‰å¾…çŠ¶æ€æ ·å¼ */
        .response-content.waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-weight: 500;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .examples {
            margin-top: 20px;
        }

        .examples h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .example-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-left: 3px solid #667eea;
        }

        .example-item:hover {
            background: #e9ecef;
        }

        .example-category {
            font-weight: 600;
            color: #667eea;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metadata {
            background: #e3f2fd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
        }

        .metadata h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .metadata-item {
            margin-bottom: 5px;
        }

        .chat-mode {
            border: 2px solid #28a745;
        }

        .chat-mode h2::before {
            content: "ğŸ’¬ ";
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:first-child {
            border-radius: 8px 0 0 8px;
        }

        .tab-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .system-info {
            grid-column: 1 / -1;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .system-info h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        /* å¯¹è¯æ¨¡å¼ä¸“ç”¨æ ·å¼ */
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
            margin-bottom: 15px;
            min-height: 350px;
            max-height: 400px;
        }

        .chat-input-area {
            border-top: 1px solid #e1e5e9;
            padding-top: 15px;
            background-color: #fff;
            margin-top: auto;
        }

        .chat-textarea {
            min-height: 60px !important;
            max-height: 120px;
            resize: vertical;
        }

        .chat-buttons {
            display: flex;
            gap: 10px;
        }

        .chat-buttons .btn {
            flex: 1;
        }

        /* ä¿®å¤å¯¹è¯æ¨¡å¼çš„tabæŒ‰é’® */
        .chat-mode .tab-btn.active {
            background: #28a745;
            color: white;
        }

        /* å¯¹è¯æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
        .chat-messages .message-user {
            background-color: #e3f2fd;
            margin-left: 20px;
            margin-right: 0;
            text-align: right;
        }

        .chat-messages .message-assistant {
            background-color: #f3e5f5;
            margin-right: 20px;
            margin-left: 0;
        }

        .chat-messages .message-system {
            background-color: #fff3e0;
            margin: 0 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ é€šç”¨æ™ºèƒ½å‡ºè¡ŒæœåŠ¡</h1>
            <p>åŸºäºLLMæ¨ç†çš„æ™ºèƒ½å‡ºè¡ŒåŠ©æ‰‹ - æ”¯æŒç§Ÿæˆ¿ã€æ—…æ¸¸ã€è·¯çº¿è§„åˆ’ç­‰å¤šç§åœºæ™¯</p>
        </div>

        <div class="system-info">
            <h3>ç³»ç»Ÿæ¶æ„è¯´æ˜</h3>
            <p>â€¢ <strong>LLMæ¨ç†å¼•æ“</strong>: ä½¿ç”¨Google Geminiåˆ†æç”¨æˆ·æ„å›¾ï¼Œæ™ºèƒ½åˆ¶å®šåˆ†æè®¡åˆ’</p>
            <p>â€¢ <strong>åŠ¨æ€å·¥å…·è°ƒç”¨</strong>: æ ¹æ®éœ€æ±‚è‡ªåŠ¨é€‰æ‹©å’Œè°ƒç”¨é«˜å¾·åœ°å›¾MCPå·¥å…·</p>
            <p>â€¢ <strong>åœºæ™¯è¯†åˆ«</strong>: è‡ªåŠ¨è¯†åˆ«ç§Ÿæˆ¿ã€æ—…æ¸¸ã€è·¯çº¿è§„åˆ’ã€åœ°ç‚¹æœç´¢ã€ä½å®¿æ¨èç­‰åœºæ™¯</p>
            <p>â€¢ <strong>å¤šè½®å¯¹è¯</strong>: æ”¯æŒä¸Šä¸‹æ–‡å¯¹è¯ï¼Œé€æ­¥å®Œå–„éœ€æ±‚</p>
        </div>

        <!-- ä½¿ç”¨ç¤ºä¾‹ -->
        <div class="card examples-section">
            <div class="examples">
                <h3>ğŸ“ ä½¿ç”¨ç¤ºä¾‹ 
                    <button class="examples-toggle" onclick="toggleExamples()">å±•å¼€æ›´å¤š</button>
                </h3>
                <div class="examples-grid" id="examples-grid">
                    <div class="example-item" onclick="fillExample(0)">
                        <div class="example-category">ç§Ÿæˆ¿åˆ†æ</div>
                        æˆ‘åœ¨åŒ—äº¬æµ·æ·€åŒºå’Œæœé˜³åŒºéƒ½æœ‰å·¥ä½œï¼Œæƒ³æ‰¾ä¸€ä¸ªé€šå‹¤æ–¹ä¾¿çš„æˆ¿å­ï¼Œé¢„ç®—5000-8000å…ƒ
                    </div>
                    <div class="example-item" onclick="fillExample(1)">
                        <div class="example-category">æ—…æ¸¸è§„åˆ’</div>
                        å¸®æˆ‘è§„åˆ’æˆéƒ½3å¤©2å¤œæ—…æ¸¸æ”»ç•¥ï¼Œå–œæ¬¢ç¾é£Ÿå’Œå†å²æ–‡åŒ–ï¼Œé¢„ç®—3000å…ƒ
                    </div>
                    <div class="example-item" onclick="fillExample(2)">
                        <div class="example-category">è·¯çº¿è§„åˆ’</div>
                        ä»ä¸Šæµ·åˆ°æ­å·æœ€ç»æµçš„å‡ºè¡Œæ–¹å¼æ˜¯ä»€ä¹ˆï¼ŸåŒ…æ‹¬æ—¶é—´å’Œè´¹ç”¨å¯¹æ¯”
                    </div>
                    <div class="example-item" onclick="fillExample(3)">
                        <div class="example-category">å•†åŠ¡å‡ºè¡Œ</div>
                        ä¸‹å‘¨è¦å»æ·±åœ³å‡ºå·®2å¤©ï¼Œéœ€è¦ä½åœ¨ä¼šå±•ä¸­å¿ƒé™„è¿‘ï¼Œè¦æ±‚å•†åŠ¡é…’åº—ï¼Œé¢„ç®—500å…ƒ/æ™š
                    </div>
                    <div class="example-item" onclick="fillExample(4)">
                        <div class="example-category">å‘¨è¾¹æ¢ç´¢</div>
                        æˆ‘åœ¨å¹¿å·å¤©æ²³åŒºï¼Œæƒ³æ‰¾å‘¨æœ«å¯ä»¥å»çš„å¥½ç©åœ°æ–¹ï¼Œä¸è¦å¤ªè¿œï¼Œé€‚åˆæ‹ç…§
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- ä¸»è¦å·¥ä½œåŒºåŸŸ -->
            <div class="card main-workspace">
                <!-- TabæŒ‰é’® -->
                <div class="tab-buttons">
                    <div class="tab-btn active" onclick="switchMode('analysis')">ğŸ” æ™ºèƒ½åˆ†æ</div>
                    <div class="tab-btn" onclick="switchMode('chat')">ğŸ’¬ å¯¹è¯æ¨¡å¼</div>
                </div>

                <!-- åˆ†ææ¨¡å¼ -->
                <div id="analysis-card" class="workspace-content">
                    <h2>æ™ºèƒ½éœ€æ±‚åˆ†æ</h2>
                    
                    <div class="analysis-layout">
                        <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
                        <div class="input-section">
                            <div class="input-group">
                                <label for="query">æ‚¨çš„éœ€æ±‚æè¿°</label>
                                <textarea id="query" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ æˆ‘åœ¨åŒ—äº¬æµ·æ·€åŒºå’Œæœé˜³åŒºéƒ½æœ‰å·¥ä½œï¼Œæƒ³æ‰¾ä¸€ä¸ªé€šå‹¤æ–¹ä¾¿çš„æˆ¿å­ï¼Œé¢„ç®—5000-8000å…ƒ&#10;â€¢ å¸®æˆ‘è§„åˆ’æˆéƒ½3å¤©2å¤œæ—…æ¸¸æ”»ç•¥ï¼Œå–œæ¬¢ç¾é£Ÿå’Œå†å²æ–‡åŒ–&#10;â€¢ ä»ä¸Šæµ·åˆ°æ­å·æœ€ç»æµçš„å‡ºè¡Œæ–¹å¼"></textarea>
                            </div>

                            <div class="input-group">
                                <label for="preferences">åå¥½è®¾ç½® (å¯é€‰)</label>
                                <input type="text" id="preferences" placeholder="ä¾‹å¦‚ï¼šé è¿‘åœ°é“ã€ç¯å¢ƒå®‰é™ã€æ€§ä»·æ¯”é«˜">
                            </div>

                            <div class="input-group">
                                <label for="budget">é¢„ç®—çº¦æŸ (å¯é€‰)</label>
                                <input type="text" id="budget" placeholder="ä¾‹å¦‚ï¼š5000-8000å…ƒã€3000å…ƒä»¥å†…">
                            </div>

                            <div class="button-group">
                                <button class="btn" onclick="analyzeRequest()" id="analyze-btn">å¼€å§‹æ™ºèƒ½åˆ†æ</button>
                                <button class="btn btn-secondary" onclick="clearForm()">æ¸…ç©º</button>
                            </div>
                        </div>

                        <!-- å³ä¾§ï¼šåˆ†æç»“æœ -->
                        <div class="result-section">
                            <h3>ğŸ¤– åˆ†æç»“æœ</h3>
                            <div id="response-content" class="response-content">
                                ç­‰å¾…æ‚¨çš„è¾“å…¥...
                            </div>
                            <div id="metadata" class="metadata" style="display: none;">
                                <h4>ğŸ“Š åˆ†æå…ƒæ•°æ®</h4>
                                <div id="metadata-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯¹è¯æ¨¡å¼ -->
                <div id="chat-card" class="workspace-content chat-mode" style="display: none;">
                    <h2>å¯¹è¯å¼æ™ºèƒ½åŠ©æ‰‹</h2>
                    
                    <!-- å¯¹è¯çª—å£å®¹å™¨ -->
                    <div class="chat-container">
                        <!-- å¯¹è¯å†å²åŒºåŸŸ -->
                        <div id="conversation-history" class="chat-messages"></div>
                        
                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div class="chat-input-area">
                            <div class="input-group" style="margin-bottom: 10px;">
                                <textarea id="chat-message" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚..." class="chat-textarea"></textarea>
                            </div>
                            
                            <div class="chat-buttons">
                                <button class="btn" onclick="sendChatMessage()" id="chat-btn">å‘é€æ¶ˆæ¯</button>
                                <button class="btn btn-secondary" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const examples = [
            {
                query: "æˆ‘åœ¨åŒ—äº¬æµ·æ·€åŒºå’Œæœé˜³åŒºéƒ½æœ‰å·¥ä½œï¼Œæƒ³æ‰¾ä¸€ä¸ªé€šå‹¤æ–¹ä¾¿çš„æˆ¿å­ï¼Œé¢„ç®—5000-8000å…ƒ",
                preferences: "é è¿‘åœ°é“ï¼Œç¯å¢ƒå®‰é™",
                budget: "5000-8000å…ƒ"
            },
            {
                query: "å¸®æˆ‘è§„åˆ’æˆéƒ½3å¤©2å¤œæ—…æ¸¸æ”»ç•¥ï¼Œå–œæ¬¢ç¾é£Ÿå’Œå†å²æ–‡åŒ–ï¼Œé¢„ç®—3000å…ƒ",
                preferences: "ç¾é£Ÿå’Œå†å²æ–‡åŒ–",
                budget: "3000å…ƒ"
            },
            {
                query: "ä»ä¸Šæµ·åˆ°æ­å·æœ€ç»æµçš„å‡ºè¡Œæ–¹å¼æ˜¯ä»€ä¹ˆï¼ŸåŒ…æ‹¬æ—¶é—´å’Œè´¹ç”¨å¯¹æ¯”",
                preferences: "ç»æµå®æƒ ",
                budget: "è¶Šä¾¿å®œè¶Šå¥½"
            },
            {
                query: "ä¸‹å‘¨è¦å»æ·±åœ³å‡ºå·®2å¤©ï¼Œéœ€è¦ä½åœ¨ä¼šå±•ä¸­å¿ƒé™„è¿‘ï¼Œè¦æ±‚å•†åŠ¡é…’åº—ï¼Œé¢„ç®—500å…ƒ/æ™š",
                preferences: "å•†åŠ¡é…’åº—ï¼Œä¼šå±•ä¸­å¿ƒé™„è¿‘",
                budget: "500å…ƒ/æ™š"
            },
            {
                query: "æˆ‘åœ¨å¹¿å·å¤©æ²³åŒºï¼Œæƒ³æ‰¾å‘¨æœ«å¯ä»¥å»çš„å¥½ç©åœ°æ–¹ï¼Œä¸è¦å¤ªè¿œï¼Œé€‚åˆæ‹ç…§",
                preferences: "é€‚åˆæ‹ç…§ï¼Œä¸è¦å¤ªè¿œ",
                budget: "ä¸é™"
            }
        ];

        let currentConversationId = null;
        let currentMode = 'analysis';
        let examplesExpanded = false;

        function toggleExamples() {
            const examplesGrid = document.getElementById('examples-grid');
            const toggleBtn = document.querySelector('.examples-toggle');
            
            examplesExpanded = !examplesExpanded;
            
            if (examplesExpanded) {
                examplesGrid.classList.add('expanded');
                toggleBtn.textContent = 'æ”¶èµ·';
            } else {
                examplesGrid.classList.remove('expanded');
                toggleBtn.textContent = 'å±•å¼€æ›´å¤š';
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            const analysisCard = document.getElementById('analysis-card');
            const chatCard = document.getElementById('chat-card');
            const tabBtns = document.querySelectorAll('.tab-btn');

            // æ¸…é™¤æ‰€æœ‰activeçŠ¶æ€
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // éšè—æ‰€æœ‰workspaceå†…å®¹
            document.querySelectorAll('.workspace-content').forEach(content => {
                content.style.display = 'none';
            });

            if (mode === 'analysis') {
                analysisCard.style.display = 'block';
                tabBtns[0].classList.add('active');
            } else {
                chatCard.style.display = 'block';
                tabBtns[1].classList.add('active');
                
                // ç¡®ä¿å¯¹è¯åŒºåŸŸæ­£ç¡®æ˜¾ç¤º
                const conversationHistory = document.getElementById('conversation-history');
                if (conversationHistory.innerHTML.trim() === '') {
                    conversationHistory.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px;">å¼€å§‹å¯¹è¯å§ï¼æ‚¨å¯ä»¥è¯¢é—®ä»»ä½•å‡ºè¡Œç›¸å…³çš„é—®é¢˜ã€‚</div>';
                }
            }
        }

        function fillExample(index) {
            if (currentMode === 'analysis') {
                const example = examples[index];
                document.getElementById('query').value = example.query;
                document.getElementById('preferences').value = example.preferences;
                document.getElementById('budget').value = example.budget;
            } else {
                const example = examples[index];
                document.getElementById('chat-message').value = example.query;
            }
        }

        async function analyzeRequest() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æ‚¨çš„éœ€æ±‚æè¿°');
                return;
            }

            const preferences = document.getElementById('preferences').value.trim();
            const budget = document.getElementById('budget').value.trim();

            const btn = document.getElementById('analyze-btn');
            const responseContent = document.getElementById('response-content');
            const metadata = document.getElementById('metadata');

            btn.disabled = true;
            btn.textContent = 'åˆ†æä¸­...';
            responseContent.innerHTML = '<div class="loading">æ­£åœ¨è¿›è¡Œæ™ºèƒ½åˆ†æï¼Œè¯·ç¨å€™</div>';
            metadata.style.display = 'none';

            try {
                const requestData = {
                    query: query,
                    preferences: preferences,
                    constraints: budget ? { budget: budget } : {}
                };

                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    // ä½¿ç”¨Markdownæ¸²æŸ“
                    responseContent.innerHTML = renderMarkdown(result.response);
                    
                    // æ˜¾ç¤ºå…ƒæ•°æ®
                    const metadataContent = document.getElementById('metadata-content');
                    metadataContent.innerHTML = `
                        <div class="metadata-item"><strong>åˆ†æç±»å‹:</strong> ${result.analysis_type}</div>
                        <div class="metadata-item"><strong>å¤„ç†æ—¶é—´:</strong> ${result.metadata.processing_time.toFixed(2)}ç§’</div>
                        <div class="metadata-item"><strong>å·¥å…·è°ƒç”¨æ¬¡æ•°:</strong> ${result.metadata.tool_calls_count}æ¬¡</div>
                        <div class="metadata-item"><strong>ä½¿ç”¨çš„å·¥å…·:</strong> ${result.tools_used.join(', ') || 'æ— '}</div>
                        <div class="metadata-item"><strong>ç½®ä¿¡åº¦:</strong> ${(result.metadata.analysis_confidence * 100).toFixed(1)}%</div>
                        <div class="metadata-item"><strong>æ•°æ®æº:</strong> ${Array.from(result.metadata.data_sources).join(', ')}</div>
                    `;
                    metadata.style.display = 'block';
                } else {
                    responseContent.innerHTML = `âŒ åˆ†æå¤±è´¥: ${result.message || result.error}`;
                }

            } catch (error) {
                responseContent.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹æ™ºèƒ½åˆ†æ';
            }
        }

        async function sendChatMessage() {
            const message = document.getElementById('chat-message').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯');
                return;
            }

            const btn = document.getElementById('chat-btn');
            const conversationHistory = document.getElementById('conversation-history');

            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
            addMessageToHistory('user', message);
            document.getElementById('chat-message').value = '';

            // æ·»åŠ åŠ è½½æç¤º
            const loadingId = addMessageToHistory('assistant', 'æ­£åœ¨æ€è€ƒä¸­...', true);

            try {
                const requestData = {
                    message: message,
                    conversation_id: currentConversationId
                };

                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                // ç§»é™¤åŠ è½½æç¤º
                document.getElementById(loadingId).remove();

                if (result.success) {
                    currentConversationId = result.conversation_id;
                    addMessageToHistory('assistant', result.response, false, true); // å¯ç”¨Markdownæ¸²æŸ“
                    
                    // æ˜¾ç¤ºå»ºè®®ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (result.suggestions && result.suggestions.length > 0) {
                        const suggestionsHtml = result.suggestions.map(s => `<button class="btn" style="margin: 5px; padding: 5px 10px; font-size: 12px;" onclick="document.getElementById('chat-message').value='${s}'">${s}</button>`).join('');
                        addMessageToHistory('system', `ğŸ’¡ å»ºè®®: ${suggestionsHtml}`);
                    }
                } else {
                    addMessageToHistory('assistant', `âŒ å¤„ç†å¤±è´¥: ${result.error}`);
                }

            } catch (error) {
                // ç§»é™¤åŠ è½½æç¤º
                document.getElementById(loadingId).remove();
                addMessageToHistory('assistant', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'å‘é€æ¶ˆæ¯';
            }
        }

        function addMessageToHistory(role, content, isLoading = false) {
            const conversationHistory = document.getElementById('conversation-history');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.marginBottom = '15px';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '8px';
            
            if (role === 'user') {
                messageDiv.style.backgroundColor = '#e3f2fd';
                messageDiv.style.marginLeft = '20px';
                messageDiv.innerHTML = `<strong>ğŸ‘¤ æ‚¨:</strong><br>${content}`;
            } else if (role === 'assistant') {
                messageDiv.style.backgroundColor = '#f3e5f5';
                messageDiv.style.marginRight = '20px';
                if (isLoading) {
                    messageDiv.innerHTML = `<strong>ğŸ¤– åŠ©æ‰‹:</strong><br><div class="loading" style="justify-content: flex-start;">${content}</div>`;
                } else {
                    messageDiv.innerHTML = `<strong>ğŸ¤– åŠ©æ‰‹:</strong><br>${content}`;
                }
            } else if (role === 'system') {
                messageDiv.style.backgroundColor = '#fff3e0';
                messageDiv.innerHTML = content;
            }
            
            conversationHistory.appendChild(messageDiv);
            conversationHistory.scrollTop = conversationHistory.scrollHeight;
            
            return messageId;
        }

        function clearForm() {
            document.getElementById('query').value = '';
            document.getElementById('preferences').value = '';
            document.getElementById('budget').value = '';
            document.getElementById('response-content').innerHTML = 'ç­‰å¾…æ‚¨çš„è¾“å…¥...';
            document.getElementById('metadata').style.display = 'none';
        }

        function clearChat() {
            document.getElementById('chat-message').value = '';
            document.getElementById('conversation-history').innerHTML = '';
            currentConversationId = null;
        }

        // æ”¯æŒEnteré”®å‘é€æ¶ˆæ¯
        document.getElementById('chat-message').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        });

        // Markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdown(markdownText) {
            try {
                // é…ç½®markedé€‰é¡¹
                marked.setOptions({
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {}
                        }
                        return hljs.highlightAuto(code).value;
                    },
                    breaks: true,
                    gfm: true
                });
                
                // æ¸²æŸ“Markdown
                return marked.parse(markdownText);
            } catch (error) {
                console.error('Markdownæ¸²æŸ“å¤±è´¥:', error);
                // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬ï¼ˆä½†è¿›è¡ŒHTMLè½¬ä¹‰ï¼‰
                return markdownText.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            }
        }

        // æ›´æ–°addMessageToHistoryå‡½æ•°ä»¥æ”¯æŒMarkdownæ¸²æŸ“
        function addMessageToHistory(role, content, isLoading = false, useMarkdown = false) {
            const conversationHistory = document.getElementById('conversation-history');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.marginBottom = '15px';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '8px';
            
            if (role === 'user') {
                messageDiv.style.backgroundColor = '#e3f2fd';
                messageDiv.style.marginLeft = '20px';
                messageDiv.innerHTML = `<strong>ğŸ‘¤ æ‚¨:</strong><br>${content}`;
            } else if (role === 'assistant') {
                messageDiv.style.backgroundColor = '#f3e5f5';
                messageDiv.style.marginRight = '20px';
                if (isLoading) {
                    messageDiv.innerHTML = `<strong>ğŸ¤– åŠ©æ‰‹:</strong><br><div class="loading" style="justify-content: flex-start;">${content}</div>`;
                } else {
                    const renderedContent = useMarkdown ? renderMarkdown(content) : content;
                    messageDiv.innerHTML = `<strong>ğŸ¤– åŠ©æ‰‹:</strong><br><div style="margin-top: 8px;">${renderedContent}</div>`;
                }
            } else if (role === 'system') {
                messageDiv.style.backgroundColor = '#fff3e0';
                messageDiv.innerHTML = content;
            }
            
            conversationHistory.appendChild(messageDiv);
            conversationHistory.scrollTop = conversationHistory.scrollHeight;
            
            return messageId;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç³»ç»Ÿèƒ½åŠ›
        window.addEventListener('load', async function() {
            try {
                const response = await fetch('/capabilities');
                const capabilities = await response.json();
                console.log('ç³»ç»Ÿèƒ½åŠ›:', capabilities);
            } catch (error) {
                console.error('è·å–ç³»ç»Ÿèƒ½åŠ›å¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>
